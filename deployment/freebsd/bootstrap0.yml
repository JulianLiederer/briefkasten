---
# run this with ansible-playbook bootstrap.yml -k -c paramiko

- hosts: jails_host
  gather_facts: false
  remote_user: root
  handlers:
    - name: restart sshd
      service: name=sshd state=restarted

  tasks:
  - name: install pkgng
    raw: "pkg_info | grep -v 'pkg-' > /dev/null ; if $? pkg_add -r pkg; rehash ; pkg2ng; echo 'WITH_PKGNG=yes' >> /etc/make.conf; echo 'packagesite: http://pkgbeta.freebsd.org/freebsd%3A9%3Ax86%3A64/latest' >> /usr/local/etc/pkg.conf; pkg update ; pkg upgrade -y"
  - name: install python27
    raw: "pkg install -y python27"
  - name: add ansible ssh-key
    authorized_key: user=root key="{{ item }}"
    with_file:
        - ~/.ssh/identity.pub
  - name: disable password login for root
    copy: src=sshd_config dest=/etc/ssh/sshd_config group=wheel owner=root mode=644
    notify: restart sshd

  - name: ensure sshd is up
    service: name=sshd enabled=yes

