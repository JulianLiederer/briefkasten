---

- name: create application user
  # this creates /home/pyramid/.ssh/id_rsa{.pub}
  user: name={{appuser}} createhome=yes generate_ssh_key=yes

- name: configure supervisord
  template: src=supervisord.conf.j2 dest=/usr/local/etc/supervisord.conf

- name: enable supervisord at startup time
  lineinfile: dest=/etc/rc.conf state=present line='supervisord_enable=YES' create=yes

- name: ensure application directory
  file: path={{apphome}} state=directory owner={{appuser}} mode=770

- name: ensure log directory
  file: path={{apphome}}/log state=directory owner={{appuser}} mode=770

- name: ensure pgp directory
  file: path={{apphome}}/pgp_pubkeys state=directory owner={{appuser}} mode=770

- name: find absolute path to our repo
  connection: local
  command: git rev-parse --show-toplevel
  register: git_base

- name: clear work directory
  connection: local
  command: rm -rf {{ git_base.stdout }}/deployment/freebsd/workdir/*

- name: check out clean copy of the local git repo
  connection: local
  command: git --work-tree={{ git_base.stdout }} checkout-index -a -f --prefix={{ git_base.stdout }}/deployment/freebsd/workdir/ chdir={{ git_base.stdout }}

- name: upload application
  connection: local
  command: 'rsync -av  -e "ssh -F ssh_config" workdir/application/ appserver:{{apphome}}/'

- name: make sure supervisord is running
  service: name=supervisord state=running

